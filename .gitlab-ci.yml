image: python:3.12


stages:
  - test
  - deploy

variables:
  DBT_PROFILES_DIR: "$CI_PROJECT_DIR"
  DBT_PROJECT_DIR: "$CI_PROJECT_DIR/sql_server_project"

before_script:
  - apt-get update
  - apt-get install -y curl gnupg2
  - curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
  - curl https://packages.microsoft.com/config/debian/11/prod.list > /etc/apt/sources.list.d/mssql-release.list
  - apt-get update
  - ACCEPT_EULA=Y apt-get install -y msodbcsql17 unixodbc-dev
  - pip install --upgrade pip
  - pip install -r requirements.txt


# Test your dbt models
test_models:
  stage: test
  script:
    - echo "üîç Checking environment variables..."
    - echo "DB_HOST is set to:" $DB_HOST
    - echo "DB_USER is set to:" $DB_USER
    - echo "DB_PASSWORD is:" ${DB_PASSWORD:0:3}***  # Show only first 3 chars of password
    - cd $DBT_PROJECT_DIR
    - dbt deps
    - dbt debug  # This will show connection details
    - dbt compile
    - dbt test
  only:
    - merge_requests
    - main
  allow_failure: true

# Deploy your models
deploy_models:
  stage: deploy
  script:
    - cd $DBT_PROJECT_DIR
    - dbt deps
    - dbt debug
    - dbt run
    - dbt test
  only:
    - main
  when: manual